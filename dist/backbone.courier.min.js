/*
 * Backbone.Courier, v0.5.7
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(e,t){var n=/^(\S+)\s*(.*)$/,i=t.isFunction($)?$("body")[0]:null;e.Courier={},e.Courier.add=function(a){function s(e){t.isFunction(e.$el.data)&&!e.$el.data("view")&&e.$el.data("view",e)}function r(e){var i=this.uiBindings||t.result(this,"ui");if(!i)return e;var a={};return t.each(e,function(e,s){var r=s.match(n),l=r[1],o=r[2];if(""!==o&&!t.isUndefined(i[o])){var u=i[o];s=l+" "+u}a[s]=e}),a}function l(e,i,a){var s=[];for(var r in e){var l=r.match(n),o=l[1],u=l[2],c=RegExp(o.replace("*","[\\w]*"));c.test(i.name)&&(""===u||a._getChildViewNamed(u)===i.source)&&s.push({eventName:o,subviewName:u,value:e[r]})}return s.length>1&&(s=t.sortBy(s,function(e){var t=e.eventName.replace("*",""),n=""!==u,i=(n?1e3:0)+t.length;return-i})),s.length?s[0].value:null}var o={delegateEvents:a.delegateEvents,setElement:a.setElement};a.spawn=function(e,n){if(t.isString(e))e={name:e,data:t.extend({},n)};else if(t.isUndefined(e.name))throw Error("Undefined message name.");e.source=a,e.data=e.data||{};for(var i,s,r="!"===e.name[e.name.length-1],o=this._getParentView();o;){if(t.isObject(o.onMessages)&&(s=l(o.onMessages,e,o),null!==s)){var u=s;if(t.isFunction(u)||(u=o[s]),!u)throw Error('Method "'+s+'" does not exist');var c=u.call(o,e);if(r)return c}if(i=!1,t.isObject(o.passMessages))if(s=l(o.passMessages,e,o),null!==s){if("."===s);else if(t.isString(s))e.name=s;else{if(!t.isFunction(s))throw new TypeError;var h=e.data;e.data={},s.call(o,e,h)}i=!0}else r&&(i=!0);if(r&&(i=!0),!i)break;e.source=o,o=o._getParentView()}if(r)throw Error('Round trip message "'+e.name+'" was not handled. All round trip messages must be handled.')},t.isFunction(a._getParentView)||(a._getParentView=function(){for(var t=null,n=this.$el.parent();n.length>0&&n[0]!==i;){var a=n.data("view");if(a&&a instanceof e.View){t=a;break}n=n.parent()}return t}),t.isFunction(a._getChildViewNamed)||(a._getChildViewNamed=function(e){return t.isObject(this.subviews)?this.subviews[e]:null}),a.delegateEvents=function(e){var i=this;t.isFunction(this.events)&&(this.events=this.events.call(this.events)),e=e||t.clone(this.events)||{},e=r.call(this,e);var a=t.result(this,"spawnMessages")||{};a=r.call(this,a),t.each(a,function(a,s){var r=s.match(n),l=r[1];r[2];var o=function(e){e&&e.preventDefault&&e.preventDefault(),e&&e.stopPropagation&&e.stopPropagation();var n;if(t.isFunction(a))n={name:l,data:{},source:i},a.call(this,n,e);else{if(!t.isString(a))throw new TypeError;n=a}this.spawn(n)};if(e[s]){var u=e[s];if(t.isFunction(u)||(u=i[e[s]]),!u)throw Error('Method "'+e[s]+'" does not exist');e[s]=function(){u.apply(this,arguments),o.apply(this,arguments)}}else e[s]=o}),o.delegateEvents.call(this,e)},a.setElement=function(e,t){o.setElement.call(this,e,t),s(a)},s(a),a.delegateEvents()}})(Backbone,_);