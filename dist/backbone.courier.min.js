/*
 * Backbone.Courier, v3.0.1
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],b):"undefined"!=typeof exports?module.exports=b(require("underscore"),require("backbone"),require("backbone").$):b(a._,a.Backbone,a.jQuery||a.Zepto||a.$)}(this,function(a,b,c){var d=/^(\S+)\s*(.*)$/,e=a.isFunction(c)?c("body")[0]:null;return b.Courier={},b.Courier.add=function(b){function c(b){a.isFunction(b.$el.data)&&!b.$el.data("view")&&b.$el.data("view",b)}function f(b,c,e){var f=[];for(var g in b){var h=g.match(d),i=h[1],j=h[2],k=new RegExp("^"+i.replace(/\*/g,"[\\w]*")+"$");k.test(c.name)&&(""===j||e._getChildViewNamed(j)===c.source)&&f.push({eventName:i,subviewName:j,value:b[g]})}return f.length>1&&(f=a.sortBy(f,function(a){var b=a.eventName.replace("*",""),c=""!==a.subviewName,d=(c?1e3:0)+b.length;return-d})),f.length?f[0].value:null}var g={setElement:b.setElement};b.spawn=function(c,d){if(a.isString(c))c={name:c,data:d};else if(a.isUndefined(c.name))throw new Error("Undefined message name.");c.source=b,c.data=a.isUndefined(c.data)?{}:c.data,this.trigger(c.name,c.data);for(var e,g,h="!"===c.name.charAt(c.name.length-1),i=this._getParentView();i;){if(a.isObject(i.onMessages)&&(g=f(i.onMessages,c,i),null!==g)){var j=g;if(a.isFunction(j)||(j=i[g]),!j)throw new Error('Method "'+g+'" does not exist');var k=j.call(i,c.data,c.source,c.name);if(h)return k}e=h;var l=a.result(i,"passMessages");if(a.isObject(l)&&(g=f(l,c,i),null!==g)){if("."===g);else{if(!a.isString(g))throw new TypeError("Values of passMessages hash should be strings.");c.name=g}e=!0}if(!e)break;c.source=i,i=i._getParentView()}return void 0},a.isFunction(b._getParentView)||(b._getParentView=function(){for(var b=null,c=this.$el.parent();c.length>0&&c[0]!==e;){var d=c.data("view");if(d&&a.isFunction(d.render)){b=d;break}c=c.parent()}return b}),a.isFunction(b._getChildViewNamed)||(b._getChildViewNamed=function(b){return a.isObject(this.subviews)?this.subviews[b]:null}),b.setElement=function(a,d){var e=g.setElement.call(this,a,d);return c(b),e},b.$el&&c(b)},b.Courier});