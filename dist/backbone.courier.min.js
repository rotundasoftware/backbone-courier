/*
 * Backbone.Courier, v4.0.0
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],b):"undefined"!=typeof exports?module.exports=b(require("underscore"),require("backbone"),require("backbone").$):b(a._,a.Backbone,a.jQuery||a.Zepto||a.$)}(this,function(a,b,c){var d=/^(\S+)\s*(.*)$/,e=a.isFunction(c)?c("body")[0]:null;return b.Courier={},b.Courier.add=function(c){function e(b){a.isFunction(b.$el.data)&&!b.$el.data("view")&&b.$el.data("view",b)}function f(b,c,e,f){var g=[];for(var h in b){var i=h.match(d),j=i[1],k=i[2],l=new RegExp("^"+j.replace(/\*/g,"[\\w]*")+"$");l.test(c.name)&&(""===k||e._getChildViewNamed(k)===f)&&g.push({eventName:j,subviewName:k,value:b[h]})}return g.length>1&&(g=a.sortBy(g,function(a){var b=a.eventName.replace("*",""),c=""!==a.subviewName,d=(c?1e3:0)+b.length;return-d})),g.length?g[0].value:null}var g={setElement:c.setElement};c.spawn=function(b,d){if(a.isString(b))b={name:b,data:d};else if(a.isUndefined(b.name))throw new Error("Undefined message name.");b.source=c,b.data=a.isUndefined(b.data)?{}:b.data,this.trigger(b.name,b.data);for(var e,g,h="!"===b.name.charAt(b.name.length-1),i=this,j=this._getParentView();j;){if(a.isObject(j.onMessages)&&(g=f(j.onMessages,b,j,i),null!==g)){var k=g;if(a.isFunction(k)||(k=j[g]),!k)throw new Error('Method "'+g+'" does not exist');var l=k.call(j,b.data,b.source,b.name);if(h)return l}if(h)e=!0;else{var m=a.result(j,"passMessages");if(!a.isUndefined(m))if(a.isBoolean(m))e=m;else{if(!a.isArray(m))throw new TypeError("passMessages should be boolean or an array.");e=a.contains(m,b.name)}}if(!e)break;i=j,j=j._getParentView()}return void 0},a.isFunction(c._getParentView)||(c._getParentView=function(){return b.Courier.findClosestParentView(c)}),a.isFunction(c._getChildViewNamed)||(c._getChildViewNamed=function(b){return a.isObject(this.subviews)?this.subviews[b]:null}),c.setElement=function(a,b){var d=g.setElement.call(this,a,b);return e(c),d},c.$el&&e(c)},b.Courier.findClosestParentView=function(b){for(var c=null,d=b.$el.parent();d.length>0&&d[0]!==e;){var f=d.data("view");if(f&&a.isFunction(f.render)){c=f;break}d=d.parent()}return c},b.Courier});