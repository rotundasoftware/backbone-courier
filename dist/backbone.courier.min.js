/*
 * Backbone.Courier, v3.1.0
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],b):"undefined"!=typeof exports?module.exports=b(require("underscore"),require("backbone"),require("backbone").$):b(a._,a.Backbone,a.jQuery||a.Zepto||a.$)}(this,function(a,b,c){var d=/^(\S+)\s*(.*)$/,e=a.isFunction(c)?c("body")[0]:null;return b.Courier={},b.Courier.add=function(c){function e(b){a.isFunction(b.$el.data)&&!b.$el.data("view")&&b.$el.data("view",b)}function f(b,c,e){var f=[];for(var g in b){var h=g.match(d),i=h[1],j=h[2],k=new RegExp("^"+i.replace(/\*/g,"[\\w]*")+"$");k.test(c.name)&&(""===j||e._getChildViewNamed(j)===c.source)&&f.push({eventName:i,subviewName:j,value:b[g]})}return f.length>1&&(f=a.sortBy(f,function(a){var b=a.eventName.replace("*",""),c=""!==a.subviewName,d=(c?1e3:0)+b.length;return-d})),f.length?f[0].value:null}var g={setElement:c.setElement};c.spawn=function(b,d){if(a.isString(b))b={name:b,data:d};else if(a.isUndefined(b.name))throw new Error("Undefined message name.");b.source=c,b.data=a.isUndefined(b.data)?{}:b.data,this.trigger(b.name,b.data);for(var e,g,h="!"===b.name.charAt(b.name.length-1),i=this._getParentView();i;){if(a.isObject(i.onMessages)&&(g=f(i.onMessages,b,i),null!==g)){var j=g;if(a.isFunction(j)||(j=i[g]),!j)throw new Error('Method "'+g+'" does not exist');var k=j.call(i,b.data,b.source,b.name);if(h)return k}if(h)e=!0;else{var l=a.result(i,"passMessages");if(!a.isUndefined(l))if(a.isBoolean(l))e=l;else{if(!a.isArray(l))throw new TypeError("passMessages should be boolean or an array.");e=a.contains(l,b.name)}}if(!e)break;i=i._getParentView()}return void 0},a.isFunction(c._getParentView)||(c._getParentView=function(){return b.Courier.findClosestParentView(c)}),a.isFunction(c._getChildViewNamed)||(c._getChildViewNamed=function(b){return a.isObject(this.subviews)?this.subviews[b]:null}),c.setElement=function(a,b){var d=g.setElement.call(this,a,b);return e(c),d},c.$el&&e(c)},b.Courier.findClosestParentView=function(b){for(var c=null,d=b.$el.parent();d.length>0&&d[0]!==e;){var f=d.data("view");if(f&&a.isFunction(f.render)){c=f;break}d=d.parent()}return c},b.Courier});